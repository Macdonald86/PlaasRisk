<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Farm Climate Analysis</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  
  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Previous CSS remains unchanged */
    
    /* New styles for crop yield section */
    .crop-yield-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-top: 3px solid #8bc34a;
    }
    
    .crop-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    
    .crop-item {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    .crop-icon {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }
    
    .crop-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #388e3c;
    }
    
    .crop-label {
      font-size: 0.9rem;
      color: #555;
      margin-top: 5px;
    }
    
    /* Risk score styles */
    .risk-score-container {
      display: flex;
      align-items: center;
      margin-top: 15px;
      padding: 12px;
      background: #fff8e1;
      border-radius: 8px;
      border-left: 4px solid #f57c00;
    }
    
    .risk-score-value {
      font-size: 2.2rem;
      font-weight: 700;
      margin-right: 15px;
      min-width: 80px;
      text-align: center;
    }
    
    .risk-score-text {
      flex: 1;
    }
    
    .risk-score-label {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .risk-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .risk-fill {
      height: 100%;
      background: #f57c00;
      width: 0%;
    }
    
    .risk-legend {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #777;
      margin-top: 5px;
    }
    
    .risk-low { color: #4caf50; }
    .risk-medium { color: #ff9800; }
    .risk-high { color: #f44336; }
    
    /* New icons */
    .fa-corn:before { content: "ðŸŒ½"; }
    .fa-soybean:before { content: "ðŸ¥œ"; }
    .fa-wheat:before { content: "ðŸŒ¾"; }
  </style>
</head>
<body>
  <!-- Existing HTML structure remains unchanged until the report section -->
  
  <div class="report-section">
    <!-- Existing report header -->
    
    <div class="report-content">
      <!-- Existing sections -->
      
      <div id="report" class="hidden">
        <!-- Existing location details -->
        
        <!-- New Crop Yield Analysis Section -->
        <div class="crop-yield-card">
          <h3>
            <i class="fas fa-tractor"></i>
            Crop Yield Analysis (FAO Data)
          </h3>
          <p id="country-text" style="margin-bottom: 12px; font-size: 0.95rem;"></p>
          
          <div class="crop-grid">
            <div class="crop-item">
              <div class="crop-icon">
                <i class="fas fa-corn"></i>
              </div>
              <div class="crop-value" id="maize-yield">-</div>
              <div class="crop-label">Maize Yield (t/ha)</div>
            </div>
            
            <div class="crop-item">
              <div class="crop-icon">
                <i class="fas fa-soybean"></i>
              </div>
              <div class="crop-value" id="soybean-yield">-</div>
              <div class="crop-label">Soybean Yield (t/ha)</div>
            </div>
            
            <div class="crop-item">
              <div class="crop-icon">
                <i class="fas fa-wheat"></i>
              </div>
              <div class="crop-value" id="wheat-yield">-</div>
              <div class="crop-label">Wheat Yield (t/ha)</div>
            </div>
          </div>
          
          <p style="font-size: 0.8rem; color: #777; margin-top: 12px;">
            <i class="fas fa-info-circle"></i> Data source: FAOSTAT (5-year average)
          </p>
        </div>
        
        <!-- Existing drought summary - enhanced with risk score -->
        <div class="drought-summary">
          <h4>
            <i class="fas fa-exclamation-triangle"></i>
            Climate Risk Analysis
          </h4>
          <p id="drought-summary"></p>
          <div class="drought-years" id="drought-years"></div>
          
          <!-- Climate Risk Score -->
          <div class="risk-score-container">
            <div class="risk-score-value" id="risk-score">5.0</div>
            <div class="risk-score-text">
              <div class="risk-score-label" id="risk-label">Medium Climate Risk</div>
              <div>Combined risk assessment based on historical drought frequency and frost patterns</div>
              <div class="risk-bar">
                <div class="risk-fill" id="risk-fill"></div>
              </div>
              <div class="risk-legend">
                <span class="risk-low">Low</span>
                <span class="risk-medium">Medium</span>
                <span class="risk-high">High</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Rest of existing content -->
      </div>
    </div>
  </div>
  
  <!-- Script updates -->
  <script>
    // Country yield data (simplified example)
    const yieldData = {
      "United States": { maize: 11.2, soybean: 3.4, wheat: 3.2 },
      "China": { maize: 6.3, soybean: 1.9, wheat: 5.6 },
      "Brazil": { maize: 5.8, soybean: 3.5, wheat: 2.9 },
      "India": { maize: 3.0, soybean: 1.1, wheat: 3.4 },
      "France": { maize: 9.1, soybean: 2.8, wheat: 7.5 },
      "Argentina": { maize: 8.2, soybean: 2.9, wheat: 2.8 },
      "Germany": { maize: 9.5, soybean: 3.0, wheat: 7.8 },
      "Ukraine": { maize: 7.1, soybean: 2.1, wheat: 4.2 },
      "Canada": { maize: 10.2, soybean: 3.1, wheat: 3.5 },
      "Australia": { maize: 5.4, soybean: 1.8, wheat: 2.0 },
      "default": { maize: 5.5, soybean: 2.5, wheat: 3.5 }
    };

    // Enhanced geocodeLocation function to capture country
    function geocodeLocation(query, forSuggestions = false) {
      // Existing geocode logic
      
      // Add country to lastPolygonCenter
      lastPolygonCenter.country = item.address.country;
    }

    // Function to update yield display
    function updateYieldDisplay(countryName) {
      const country = countryName in yieldData ? countryName : "default";
      const yields = yieldData[country];
      
      document.getElementById("maize-yield").textContent = yields.maize;
      document.getElementById("soybean-yield").textContent = yields.soybean;
      document.getElementById("wheat-yield").textContent = yields.wheat;
      document.getElementById("country-text").textContent = `National average yields for ${countryName || "your region"}:`;
    }

    // Function to calculate climate risk score
    function calculateRiskScore(droughtYears, totalYears, frostData) {
      // Drought component (0-5 points)
      const droughtFrequency = droughtYears.length / totalYears;
      const droughtScore = Math.min(5, droughtFrequency * 10);
      
      // Frost component (0-5 points)
      const avgFrost = frostData.reduce((a, b) => a + b, 0) / totalYears;
      const frostScore = Math.min(5, avgFrost / 20 * 5);
      
      // Combine scores (0-10 scale)
      return Math.min(10, (droughtScore + frostScore).toFixed(1));
    }

    // Function to update risk display
    function updateRiskDisplay(score) {
      document.getElementById("risk-score").textContent = score;
      document.getElementById("risk-fill").style.width = `${score * 10}%`;
      
      let label = "";
      if (score <= 3.5) {
        label = "Low Climate Risk";
        document.getElementById("risk-label").className = "risk-score-label risk-low";
      } else if (score <= 7) {
        label = "Medium Climate Risk";
        document.getElementById("risk-label").className = "risk-score-label risk-medium";
      } else {
        label = "High Climate Risk";
        document.getElementById("risk-label").className = "risk-score-label risk-high";
      }
      
      document.getElementById("risk-label").textContent = label;
    }

    // In generateReport function after processing data
    async function generateReport() {
      // Existing data processing
      
      // Calculate and display risk score
      const riskScore = calculateRiskScore(droughtYears, years.length, frostData);
      updateRiskDisplay(riskScore);
      
      // Update yield display
      if (lastPolygonCenter && lastPolygonCenter.country) {
        updateYieldDisplay(lastPolygonCenter.country);
      } else {
        // Fallback to coordinates-based country detection
        try {
          const country = await reverseGeocode(lat, lon);
          updateYieldDisplay(country);
        } catch (error) {
          console.error("Country detection failed:", error);
          document.getElementById("country-text").textContent = "National yield data: Country not identified";
        }
      }
    }
    
    // Helper function to get country from coordinates
    async function reverseGeocode(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data.address.country || "Unknown";
      } catch (error) {
        console.error("Reverse geocoding error:", error);
        return "Unknown";
      }
    }
  </script>
</body>
</html>
